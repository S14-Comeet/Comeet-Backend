<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.backend.domain.recommendation.mapper.query.RecommendationQueryMapper">

    <resultMap id="MenuWithBeanScoreResultMap" type="com.backend.domain.recommendation.dto.internal.MenuWithBeanScoreDto">
        <result property="menuId" column="menu_id"/>
        <result property="menuName" column="menu_name"/>
        <result property="menuDescription" column="menu_description"/>
        <result property="menuPrice" column="menu_price"/>
        <result property="menuImageUrl" column="menu_image_url"/>
        <result property="storeId" column="store_id"/>
        <result property="storeName" column="store_name"/>
        <result property="storeAddress" column="store_address"/>
        <result property="storeLatitude" column="store_latitude"/>
        <result property="storeLongitude" column="store_longitude"/>
        <result property="beanId" column="bean_id"/>
        <result property="beanName" column="bean_name"/>
        <result property="beanCountry" column="bean_country"/>
        <result property="roasteryName" column="roastery_name"/>
        <result property="acidity" column="acidity"/>
        <result property="body" column="body"/>
        <result property="sweetness" column="sweetness"/>
        <result property="bitterness" column="bitterness"/>
        <result property="aroma" column="aroma"/>
        <result property="flavor" column="flavor"/>
        <result property="aftertaste" column="aftertaste"/>
        <result property="totalScore" column="total_score"/>
        <result property="roastLevel" column="roast_level"/>
        <result property="flavorTags" column="flavor_tags"
                typeHandler="com.backend.common.mybatis.JsonListTypeHandler"/>
    </resultMap>

    <!-- 하드 필터링 + 위치 필터링된 메뉴 조회 -->
    <select id="findFilteredMenus" resultMap="MenuWithBeanScoreResultMap">
        SELECT
            m.id AS menu_id,
            m.name AS menu_name,
            m.description AS menu_description,
            m.price AS menu_price,
            m.image_url AS menu_image_url,
            s.id AS store_id,
            s.name AS store_name,
            s.address AS store_address,
            s.latitude AS store_latitude,
            s.longitude AS store_longitude,
            b.id AS bean_id,
            b.name AS bean_name,
            b.country AS bean_country,
            r.name AS roastery_name,
            bs.acidity,
            bs.body,
            bs.sweetness,
            bs.bitterness,
            bs.aroma,
            bs.flavor,
            bs.aftertaste,
            bs.total_score,
            bs.roast_level,
            bs.flavor_tags
        FROM menus m
        INNER JOIN stores s ON m.store_id = s.id
        INNER JOIN menu_bean_mappings mbm ON m.id = mbm.menu_id
        INNER JOIN beans b ON mbm.bean_id = b.id
        INNER JOIN bean_scores bs ON b.id = bs.bean_id
        LEFT JOIN roasteries r ON b.roastery_id = r.id
        WHERE m.deleted_at IS NULL
          AND s.deleted_at IS NULL
          AND b.deleted_at IS NULL
          AND s.is_closed = FALSE

        <!-- 위치 필터링 (BoundingBox) -->
        <if test="minLatitude != null and maxLatitude != null and minLongitude != null and maxLongitude != null">
            AND s.latitude BETWEEN #{minLatitude} AND #{maxLatitude}
            AND s.longitude BETWEEN #{minLongitude} AND #{maxLongitude}
        </if>

        <!-- disliked_tags 필터링: 비선호 태그가 있는 원두 제외 -->
        <if test="dislikedTagsJson != null and dislikedTagsJson != '[]' and dislikedTagsJson != ''">
            AND (bs.flavor_tags IS NULL OR NOT JSON_OVERLAPS(bs.flavor_tags, #{dislikedTagsJson}))
        </if>

        <!-- preferred_roast_levels 필터링 -->
        <if test="preferredRoastLevels != null and !preferredRoastLevels.isEmpty()">
            AND bs.roast_level IN
            <foreach collection="preferredRoastLevels" item="level" open="(" separator="," close=")">
                #{level}
            </foreach>
        </if>

        ORDER BY bs.total_score DESC
    </select>

    <!-- 특정 원두를 사용하는 메뉴 조회 -->
    <select id="findMenusByBeanId" resultMap="MenuWithBeanScoreResultMap">
        SELECT
            m.id AS menu_id,
            m.name AS menu_name,
            m.description AS menu_description,
            m.price AS menu_price,
            m.image_url AS menu_image_url,
            s.id AS store_id,
            s.name AS store_name,
            s.address AS store_address,
            s.latitude AS store_latitude,
            s.longitude AS store_longitude,
            b.id AS bean_id,
            b.name AS bean_name,
            b.country AS bean_country,
            r.name AS roastery_name,
            bs.acidity,
            bs.body,
            bs.sweetness,
            bs.bitterness,
            bs.aroma,
            bs.flavor,
            bs.aftertaste,
            bs.total_score,
            bs.roast_level,
            bs.flavor_tags
        FROM menus m
        INNER JOIN stores s ON m.store_id = s.id
        INNER JOIN menu_bean_mappings mbm ON m.id = mbm.menu_id
        INNER JOIN beans b ON mbm.bean_id = b.id
        INNER JOIN bean_scores bs ON b.id = bs.bean_id
        LEFT JOIN roasteries r ON b.roastery_id = r.id
        WHERE m.deleted_at IS NULL
          AND s.deleted_at IS NULL
          AND b.deleted_at IS NULL
          AND s.is_closed = FALSE
          AND b.id = #{beanId}

        <!-- 위치 필터링 (BoundingBox) -->
        <if test="minLatitude != null and maxLatitude != null and minLongitude != null and maxLongitude != null">
            AND s.latitude BETWEEN #{minLatitude} AND #{maxLatitude}
            AND s.longitude BETWEEN #{minLongitude} AND #{maxLongitude}
        </if>

        ORDER BY s.average_rating DESC, s.review_count DESC
    </select>

</mapper>
