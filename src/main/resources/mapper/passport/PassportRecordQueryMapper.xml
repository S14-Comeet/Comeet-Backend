<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.backend.domain.passport.mapper.query.PassportRecordQueryMapper">

    <select id="findRecordsByPassportId" resultType="com.backend.domain.passport.dto.common.PassportRecordDto">
        SELECT v.id           AS visit_id,
               v.created_at   AS visit_date,
               s.id           AS store_id,
               s.name         AS store_name,
               s.address      AS store_address,
               s.latitude     AS latitude,
               s.longitude    AS longitude,
               MAX(b.country) AS bean_origin,
               m.name         AS menu_name
        FROM passport_visits pv
                 INNER JOIN visits v ON pv.visit_id = v.id
                 INNER JOIN menus m ON v.menu_id = m.id
                 INNER JOIN stores s ON m.store_id = s.id
                 LEFT JOIN menu_bean_mappings mbm ON m.id = mbm.menu_id
                 LEFT JOIN beans b ON mbm.bean_id = b.id
        WHERE pv.passport_id = #{passportId}
          AND v.menu_id IS NOT NULL
        GROUP BY v.id, v.created_at, s.id, s.name, s.address, s.latitude, s.longitude, m.name
        ORDER BY v.created_at ASC
    </select>

</mapper>
