name: Claude Code Review

on:
  issue_comment:
    types: [ created ]
  pull_request:
    types: [ opened, reopened, synchronize ]

permissions:
  contents: write
  pull-requests: write
  id-token: write
  issues: write
  actions: read

jobs:
  claude-code-action:
    timeout-minutes: 60
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Run Claude PR Action
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.GMS_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.GMS_API_KEY }}
        with:
          anthropic_api_key: ${{ secrets.GMS_API_KEY }}
          use_bedrock: 'false'
          track_progress: true
          trigger_phrase: '@claude'
          claude_args: |
            --model claude-opus-4-1-20250805
            --max-turns 50
            --allowed-tools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git fetch:*),Bash(git diff:*),Bash(git log:*),Bash(git show:*)"
          prompt: |
            # 코드 리뷰 정보
            - REPO: ${{ github.repository }}
            - PR NUMBER: ${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.event.issue.number }}
            - 사용자 질문 및 요청: ${{ github.event_name == 'issue_comment' && github.event.comment.body != '' && github.event.comment.body || '내용없음' }}

            # 코드 리뷰 규칙
              ## 기본 규칙
              - **한국어**로 답변해주세요.
              - **버그 가능성, 성능 저하, 구조적 비효율성, 보안상 위험**을 우선적으로 점검하세요.
              - **클린 코드 원칙(SOLID, 일관성, 가독성, 중복 제거 등)** 에 따라 개선 제안을 제시하세요.
              - 코드 변경 내용을 언급할 때는 **핵심만 간결히 요약**하세요.
              - [사용자 질문 및 요청] 항목에 내용이 있을 경우 해당 내용을 중점으로 리뷰하세요.

              ## 절대 규칙
              - **사실 기반·근거 중심·간결한** 피드백만 작성하세요. **추측, 허구, 불확실한 근거**를 절대 포함하지 마세요. 판단이 불가능한 경우, 명시적으로 “판단 불가”라고 작성하세요.
              - **이전 Claude 리뷰와 동일하거나 중복되는 분석**을 피하세요. 반드시 새로운 관점이나 추가 위험 요인을 제시하세요.
              - **칭찬, 긍정적 감정 표현, 배경 설명**은 금지합니다. 오직 문제점, 근거, 개선 방향만 작성하세요."