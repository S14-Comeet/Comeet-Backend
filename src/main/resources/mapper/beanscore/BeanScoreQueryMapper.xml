<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.backend.domain.beanscore.mapper.query.BeanScoreQueryMapper">

    <resultMap id="BeanScoreResultMap" type="com.backend.domain.beanscore.entity.BeanScore">
        <id property="id" column="id"/>
        <result property="beanId" column="bean_id"/>
        <result property="acidity" column="acidity"/>
        <result property="body" column="body"/>
        <result property="sweetness" column="sweetness"/>
        <result property="bitterness" column="bitterness"/>
        <result property="aroma" column="aroma"/>
        <result property="flavor" column="flavor"/>
        <result property="aftertaste" column="aftertaste"/>
        <result property="totalScore" column="total_score"/>
        <result property="roastLevel" column="roast_level"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <resultMap id="BeanScoreWithBeanResultMap" type="com.backend.domain.beanscore.dto.response.BeanScoreWithBeanDto">
        <constructor>
            <arg column="bean_id" javaType="java.lang.Long"/>
            <arg column="bean_name" javaType="java.lang.String"/>
            <arg column="country" javaType="java.lang.String"/>
            <arg column="roastery_name" javaType="java.lang.String"/>
            <arg column="acidity" javaType="java.lang.Integer"/>
            <arg column="body" javaType="java.lang.Integer"/>
            <arg column="sweetness" javaType="java.lang.Integer"/>
            <arg column="bitterness" javaType="java.lang.Integer"/>
            <arg column="aroma" javaType="java.lang.Integer"/>
            <arg column="flavor" javaType="java.lang.Integer"/>
            <arg column="aftertaste" javaType="java.lang.Integer"/>
            <arg column="total_score" javaType="java.lang.Integer"/>
            <arg column="roast_level" javaType="com.backend.domain.bean.enums.RoastingLevel"/>
            <arg column="flavor_tags" javaType="java.util.List"
                 typeHandler="com.backend.common.mybatis.JsonListTypeHandler"/>
        </constructor>
    </resultMap>

    <select id="findByBeanId" resultMap="BeanScoreResultMap">
        SELECT id,
               bean_id,
               acidity,
               body,
               sweetness,
               bitterness,
               aroma,
               flavor,
               aftertaste,
               total_score,
               roast_level,
               created_at,
               updated_at
        FROM bean_scores
        WHERE bean_id = #{beanId}
    </select>

    <select id="existsByBeanId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1 FROM bean_scores WHERE bean_id = #{beanId}
        )
    </select>

    <select id="findAll" resultMap="BeanScoreResultMap">
        SELECT id,
               bean_id,
               acidity,
               body,
               sweetness,
               bitterness,
               aroma,
               flavor,
               aftertaste,
               total_score,
               roast_level,
               created_at,
               updated_at
        FROM bean_scores
    </select>

    <select id="findWithBeanByBeanId" resultMap="BeanScoreWithBeanResultMap">
        SELECT bs.bean_id,
               b.name AS bean_name,
               b.country,
               r.name AS roastery_name,
               bs.acidity,
               bs.body,
               bs.sweetness,
               bs.bitterness,
               bs.aroma,
               bs.flavor,
               bs.aftertaste,
               bs.total_score,
               bs.roast_level,
               (SELECT JSON_ARRAYAGG(f.code)
                FROM bean_flavor_notes bfn
                INNER JOIN flavors f ON bfn.flavor_id = f.id
                WHERE bfn.bean_id = bs.bean_id) AS flavor_tags
        FROM bean_scores bs
        INNER JOIN beans b ON bs.bean_id = b.id
        LEFT JOIN roasteries r ON b.roastery_id = r.id
        WHERE bs.bean_id = #{beanId}
          AND b.deleted_at IS NULL
    </select>

    <select id="findWithBeanByBeanIds" resultMap="BeanScoreWithBeanResultMap">
        SELECT bs.bean_id,
               b.name AS bean_name,
               b.country,
               r.name AS roastery_name,
               bs.acidity,
               bs.body,
               bs.sweetness,
               bs.bitterness,
               bs.aroma,
               bs.flavor,
               bs.aftertaste,
               bs.total_score,
               bs.roast_level,
               (SELECT JSON_ARRAYAGG(f.code)
                FROM bean_flavor_notes bfn
                INNER JOIN flavors f ON bfn.flavor_id = f.id
                WHERE bfn.bean_id = bs.bean_id) AS flavor_tags
        FROM bean_scores bs
        INNER JOIN beans b ON bs.bean_id = b.id
        LEFT JOIN roasteries r ON b.roastery_id = r.id
        WHERE bs.bean_id IN
        <foreach collection="beanIds" item="beanId" open="(" separator="," close=")">
            #{beanId}
        </foreach>
        AND b.deleted_at IS NULL
    </select>

    <select id="findFilteredBeanScores" resultMap="BeanScoreWithBeanResultMap">
        SELECT bs.bean_id,
               b.name AS bean_name,
               b.country,
               r.name AS roastery_name,
               bs.acidity,
               bs.body,
               bs.sweetness,
               bs.bitterness,
               bs.aroma,
               bs.flavor,
               bs.aftertaste,
               bs.total_score,
               bs.roast_level,
               (SELECT JSON_ARRAYAGG(f.code)
                FROM bean_flavor_notes bfn
                INNER JOIN flavors f ON bfn.flavor_id = f.id
                WHERE bfn.bean_id = bs.bean_id) AS flavor_tags
        FROM bean_scores bs
        INNER JOIN beans b ON bs.bean_id = b.id
        LEFT JOIN roasteries r ON b.roastery_id = r.id
        WHERE b.deleted_at IS NULL
        <!-- disliked_tags 필터링: bean_flavor_notes를 통해 필터링 -->
        <if test="dislikedTags != null and !dislikedTags.isEmpty()">
            AND NOT EXISTS (
                SELECT 1 FROM bean_flavor_notes bfn
                INNER JOIN flavors f ON bfn.flavor_id = f.id
                WHERE bfn.bean_id = bs.bean_id
                AND f.code IN
                <foreach collection="dislikedTags" item="tag" open="(" separator="," close=")">
                    #{tag}
                </foreach>
            )
        </if>
        <!-- preferred_roast_levels 필터링 -->
        <if test="preferredRoastLevels != null and !preferredRoastLevels.isEmpty()">
            AND bs.roast_level IN
            <foreach collection="preferredRoastLevels" item="level" open="(" separator="," close=")">
                #{level}
            </foreach>
        </if>
    </select>

</mapper>
