# ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„± ì‹œìŠ¤í…œ ì„¤ê³„ ë° êµ¬í˜„ ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨
1. [ì§ˆë¬¸ ë° ìš”êµ¬ì‚¬í•­](#ì§ˆë¬¸-ë°-ìš”êµ¬ì‚¬í•­)
2. [ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)
3. [ê¸°ìˆ  ìŠ¤íƒ ì„ ì •](#ê¸°ìˆ -ìŠ¤íƒ-ì„ ì •)
4. [êµ¬í˜„ ìƒì„¸](#êµ¬í˜„-ìƒì„¸)
5. [ì„±ëŠ¥ ë¶„ì„](#ì„±ëŠ¥-ë¶„ì„)
6. [Best Practice ì ìš©](#best-practice-ì ìš©)

---

## ì§ˆë¬¸ ë° ìš”êµ¬ì‚¬í•­

### ì§ˆë¬¸ 1
> https://xxeol.tistory.com/53#3.%20TaskScheduler%EB%A5%BC%20%ED%99%9C%EC%9A%A9%ED%95%9C%20%EB%8F%99%EC%A0%81%20%EC%9E%91%EC%97%85%20%EC%98%88%EC%95%BD-1 ì´ê±¸ í† ëŒ€ë¡œ í˜„ì¬ gemini image ìƒì„±ì„ TaskSchedulerì™€ Async, ë²„ì¶”ì–¼ ìŠ¤ë ˆë“œë¥¼ í†µí•œ ì‘ì—…ì„ ì§„í–‰í•˜ê³  ì‹¶ì–´! í•´ë‹¹ ë¬¸ì„œë¥¼ í™•ì¸í•˜ê³  í˜„ì¬ @GeminiImgageGenerationServiceë¥¼ ì´ë²¤íŠ¸ë¡œ ë“±ë¡í•´ì„œ ì‘ì—…ì„ ì˜ˆì•½í•˜ê³ , ì´ë¥¼ ë²„ì¶”ì–¼ ìŠ¤ë ˆë“œë¡œ ë™ì‘í•˜ê²Œ í•˜ëŠ”ê±´ ì–´ë–»ê²Œ ìƒê°í•´? í•´ë‹¹ êµ¬í˜„ì— ëŒ€í•´ì„œ ì˜ê²¬ì´ ìˆì„ê¹Œ?

### ë‹µë³€ ìš”ì•½
**TaskSchedulerì˜ ì í•©ì„± ë¬¸ì œ ì§€ì :**
- TaskSchedulerëŠ” **ì£¼ê¸°ì /ì§€ì—° ì‹¤í–‰**ì„ ìœ„í•œ ë„êµ¬
- ì´ë¯¸ì§€ ìƒì„±ì€ ì¦‰ì‹œ ì‹¤í–‰ì´ í•„ìš”í•˜ë¯€ë¡œ TaskSchedulerëŠ” ê³¼ë„í•œ ë³µì¡ì„± ìœ ë°œ

**ë” ì í•©í•œ ë°©ì‹ ì œì•ˆ:**

**Option 1: ì‹¬í”Œ Async (ì¶”ì²œ)**
```java
@Async("virtualThreadExecutor")
public CompletableFuture<String> generateAsync(String prompt) {
    // Virtual Threadì—ì„œ ì‹¤í–‰
}
```

**Option 2: Event ê¸°ë°˜ (í™•ì¥ì„± ì¤‘ì‹œ)**
```java
// ì´ë²¤íŠ¸ ë°œí–‰ â†’ ë¦¬ìŠ¤ë„ˆê°€ @Asyncë¡œ ì²˜ë¦¬
eventPublisher.publishEvent(new ImageGenerationRequestedEvent(...));
```

**Virtual Thread ì„¤ì •:**
```java
@Bean(name = "virtualThreadExecutor")
public Executor virtualThreadExecutor() {
    return Executors.newVirtualThreadPerTaskExecutor();
}
```

---

### ì§ˆë¬¸ 2
> 1. ì´ë¯¸ì§€ ìƒì„±ì—ëŠ” 2ë¶„ì •ë„ ê±¸ë ¤! ë§Œì•½ì— 1000ëª…ì˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•œë‹¤ê³  í• ë•Œ Passportì— ì •ì˜ë  ì‚¬ì§„ ë°ì´í„°ë¥¼ ë§Œë“¤ê³  ì—…ë°ì´íŠ¸ í•´ì£¼ëŠ” ê±´ë° ë„ˆë¬´ ì˜¤ë˜ ê±¸ë ¤! ê·¸ë ‡ë‹¤ê³  1000ëª…ì˜ ì‘ì—…ì„ í•œë²ˆì— ì‹¤í–‰í•˜ë©´ ìŠ¤ë ˆë“œí’€ì´ ê³ ê°ˆ ë  ê²ƒ ê°™ì•„
> 2. ê·¸ê±¸ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ë²„ì¶”ì–¼ ìŠ¤ë ˆë“œë¥¼ ìƒê°í•˜ê³ , ë¹„ë™ê¸°ì ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±ì´ ì§„í–‰ëœ í›„ ì´ë¯¸ ì •ì˜ëœ passportì— update í•´ì£¼ëŠ” ë¡œì§ìœ¼ë¡œ ìƒê°ì¤‘ì´ì•¼ ì´ë•Œ ì–´ë–»ê²Œ ìƒê°í•´? ìŠ¤ì¼€ì¤„ íƒœìŠ¤í¬ë¡œ ì´ì œ ìŠ¤ë ˆë“œí’€ ê³ ê°ˆì´ ì•ˆì´ëŸ¬ë‚˜ê²Œ ìŠ¤ë ˆë“œê°€ ë‚¨ì„ë•Œ ì‹¤í–‰ë˜ë„ë¡ ì‘ì„±í•˜ë ¤ê³ í–ˆì–´

### ë‹µë³€ ìš”ì•½
**í•µì‹¬ ìš”êµ¬ì‚¬í•­ ì´í•´:**
- 1000ëª… Ã— 2ë¶„ = 2000ë¶„ (ìˆœì°¨ ì‹¤í–‰ ì‹œ)
- ë™ì‹œ ì‹¤í–‰ ì‹œ ìŠ¤ë ˆë“œí’€ ê³ ê°ˆ ìš°ë ¤
- ì‹œìŠ¤í…œ ì•ˆì •ì„± ìœ ì§€ í•„ìš”

**ìµœì  í•´ê²°ì±…: Semaphore + Virtual Thread + Async**

#### ì™œ Semaphoreê°€ ë” ì¢‹ì€ê°€?

```java
// TaskScheduler ë°©ì‹: ë³µì¡í•˜ê³  ê´€ë¦¬ ì–´ë ¤ì›€
for (int i = 0; i < 1000; i++) {
    scheduler.schedule(task, Instant.now().plusSeconds(i * 5)); // 5ì´ˆ ê°„ê²©
}
// ë¬¸ì œ: ì •í™•í•œ ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´ ì–´ë ¤ì›€

// Semaphore ë°©ì‹: ëª…í™•í•œ ë™ì‹œì„± ì œì–´
Semaphore semaphore = new Semaphore(50); // ìµœëŒ€ 50ê°œ ë™ì‹œ ì‹¤í–‰
for (int i = 0; i < 1000; i++) {
    semaphore.acquire(); // ì—¬ìœ  ìˆì„ ë•Œë§Œ ì§„í–‰
    executeAsync(() -> {
        try {
            generateImage();
        } finally {
            semaphore.release(); // ì™„ë£Œ í›„ ìŠ¬ë¡¯ ë°˜í™˜
        }
    });
}
```

#### ì•„í‚¤í…ì²˜ ì„¤ê³„

```
[ì»¨íŠ¸ë¡¤ëŸ¬]
    â†“
[ë°°ì¹˜ ìš”ì²­]
    â†“
[BatchImageGenerationService]
    â”œâ”€ Semaphore (ë™ì‹œ ì‹¤í–‰ 50ê°œ ì œì–´)
    â”œâ”€ Virtual Thread Pool (ìˆ˜ì²œ ê°œ ìŠ¤ë ˆë“œ ê°€ëŠ¥)
    â””â”€ CompletableFuture (ë¹„ë™ê¸° ì²˜ë¦¬)
        â†“
    [ê° ì‘ì—…]
        1. Gemini ì´ë¯¸ì§€ ìƒì„± (2ë¶„)
        2. S3 ì—…ë¡œë“œ
        3. ImageGenerationCompletedEvent ë°œí–‰
        â†“
    [EventListener]
        â””â”€ Passport ì—…ë°ì´íŠ¸
```

#### ì„±ëŠ¥ ë¶„ì„

**ë™ì‹œ ì‹¤í–‰ ìˆ˜ì— ë”°ë¥¸ ì˜ˆìƒ ì™„ë£Œ ì‹œê°„:**
```
1000ëª… Ã— 2ë¶„ = 2000ë¶„ (ìˆœì°¨ ì‹¤í–‰ ì‹œ)

ë™ì‹œ ì‹¤í–‰ ìˆ˜ë³„:
- 10ê°œ: 1000 / 10 Ã— 2ë¶„ = 200ë¶„ (3ì‹œê°„ 20ë¶„)
- 50ê°œ: 1000 / 50 Ã— 2ë¶„ = 40ë¶„ âœ… ì¶”ì²œ
- 100ê°œ: 1000 / 100 Ã— 2ë¶„ = 20ë¶„ (API rate limit ì£¼ì˜)
```

#### Virtual Threadì˜ ê°•ì 

```java
// ì¼ë°˜ Platform Thread
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    50, 50,  // 50ê°œ ìŠ¤ë ˆë“œ ìƒì„± (ê° 1MB ë©”ëª¨ë¦¬)
    // ì´ ë©”ëª¨ë¦¬: 50MB
);

// Virtual Thread
Executor virtualExecutor = Executors.newVirtualThreadPerTaskExecutor();
// 1000ê°œ ìŠ¤ë ˆë“œ ìƒì„±í•´ë„ ë©”ëª¨ë¦¬ 1-2MBë§Œ ì‚¬ìš©!
// I/O ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œëŠ” CPU ìì› ê±°ì˜ ì•ˆ ì”€
```

---

### ì§ˆë¬¸ 3
> context7 ì„ í™œì„±í™”í•´ì„œ best practiceë¡œ ì´ì–´ì„œ êµ¬í˜„í•´

### ë‹µë³€ ìš”ì•½
Context7 MCPë¥¼ í™œìš©í•˜ì—¬ Spring Framework, Spring Data Redisì˜ ê³µì‹ ë¬¸ì„œì—ì„œ best practiceë¥¼ í™•ì¸í•˜ê³  í”„ë¡œì íŠ¸ ê´€í–‰ì— ë§ì¶° ì „ì²´ ì‹œìŠ¤í…œ êµ¬í˜„

---

### ì§ˆë¬¸ 4
> ì•„ ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„±ì„ ìŠ¤ì¼€ì¤„ë§ìœ¼ë¡œ ì‹¤í–‰í•˜ê²Œ í•´ì¤„ ìˆ˜ ìˆì–´? ControllerëŠ” ë‚˜ë‘ê³  ì§„í–‰í•´ë„ ë¼!

### ë‹µë³€ ìš”ì•½
**Spring @Scheduled ê¸°ë°˜ ìë™ ìŠ¤ì¼€ì¤„ë§ êµ¬í˜„:**
- ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œì— ì „ì›” ì‚¬ìš©ì ì´ë¯¸ì§€ ìë™ ìƒì„±
- `@EnableScheduling` + `@Scheduled` ì¡°í•©
- Cron í‘œí˜„ì‹ìœ¼ë¡œ ì •í™•í•œ ì‹œê°„ ì œì–´
- Controller APIëŠ” ìœ ì§€ (ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥)

**êµ¬í˜„ ë‚´ìš©:**
1. `AsyncConfig`ì— `@EnableScheduling` ì¶”ê°€
2. `PassportImageScheduler` í´ë˜ìŠ¤ ìƒì„±
   - `@Scheduled(cron = "0 0 2 1 * *")` - ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œ
   - ìë™ìœ¼ë¡œ ì „ì›” ë°©ë¬¸ì ì¡°íšŒ ë° ë°°ì¹˜ ì‹¤í–‰

**ì‹¤í–‰ ì˜ˆì‹œ:**
- 2025ë…„ 1ì›” 1ì¼ 02:00 â†’ 2024ë…„ 12ì›” ë°©ë¬¸ì ì´ë¯¸ì§€ ìë™ ìƒì„±
- 2025ë…„ 2ì›” 1ì¼ 02:00 â†’ 2025ë…„ 1ì›” ë°©ë¬¸ì ì´ë¯¸ì§€ ìë™ ìƒì„±

---

## ì•„í‚¤í…ì²˜ ì„¤ê³„

### ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Scheduler Layer                          â”‚
â”‚  PassportImageScheduler                                      â”‚
â”‚  - @Scheduled(cron = "0 0 2 1 * *") ë§¤ì›” 1ì¼ 02:00         â”‚
â”‚  - ì „ì›” ë°©ë¬¸ì ìë™ ì´ë¯¸ì§€ ìƒì„±                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Layer                             â”‚
â”‚  POST /api/batch/images                                      â”‚
â”‚  POST /api/batch/images/month/{year}/{month}                â”‚
â”‚  GET  /api/batch/images/progress/{batchId}                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BatchImageGenerationService                     â”‚
â”‚  - Semaphore(50): ë™ì‹œ ì‹¤í–‰ ì œì–´                            â”‚
â”‚  - Virtual Thread: ê²½ëŸ‰ ìŠ¤ë ˆë“œ                               â”‚
â”‚  - @Retryable: 3íšŒ ì¬ì‹œë„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GeminiImageService    â”‚      â”‚  Redis Repository    â”‚
â”‚ - AI ì´ë¯¸ì§€ ìƒì„±      â”‚      â”‚  - ì§„í–‰ ìƒí™© ì¶”ì     â”‚
â”‚ - S3 ì—…ë¡œë“œ           â”‚      â”‚  - 24ì‹œê°„ TTL        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Publishing                          â”‚
â”‚              PassportImageGeneratedEvent                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PassportImageEventListener                        â”‚
â”‚  - @Async + Virtual Thread                                  â”‚
â”‚  - Passport ì»¤ë²„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë°ì´í„° íë¦„

```
1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­
   POST /api/batch/images
   { "userIds": [1, 2, 3, ..., 1000] }

2. ë°°ì¹˜ ì‘ì—… ì´ˆê¸°í™”
   - BatchProgress ìƒì„± (Redis)
   - batchId ë°˜í™˜

3. ë¹„ë™ê¸° ì‘ì—… ì‹œì‘ (1000ê°œ)
   ê° ì‘ì—…ë§ˆë‹¤:
   - Semaphore.acquire() â†’ ëŒ€ê¸°
   - Virtual Threadì—ì„œ ì‹¤í–‰
   - Gemini API í˜¸ì¶œ (2ë¶„)
   - S3 ì—…ë¡œë“œ
   - Event ë°œí–‰
   - Semaphore.release()

4. Event ì²˜ë¦¬
   - @Async Listenerê°€ ìˆ˜ì‹ 
   - Passport.coverImageUrl ì—…ë°ì´íŠ¸
   - DB ì €ì¥

5. ì§„í–‰ ìƒí™© ì¶”ì 
   - Redisì—ì„œ ì‹¤ì‹œê°„ ì¡°íšŒ
   - completed / failed / remaining
```

---

## ê¸°ìˆ  ìŠ¤íƒ ì„ ì •

### ì„ íƒëœ ê¸°ìˆ 

| ê¸°ìˆ  | ì„ íƒ ì´ìœ  | ëŒ€ì•ˆ |
|------|-----------|------|
| **Semaphore** | ëª…í™•í•œ ë™ì‹œì„± ì œì–´, ê°„ë‹¨í•œ êµ¬í˜„ | TaskScheduler (ë³µì¡) |
| **Virtual Thread** | ê²½ëŸ‰ ìŠ¤ë ˆë“œ, I/O ëŒ€ê¸° ìµœì í™” | Platform Thread (ë©”ëª¨ë¦¬ ì†Œëª¨) |
| **@Async** | Spring í‘œì¤€, ê°„ë‹¨í•œ ë¹„ë™ê¸° ì²˜ë¦¬ | CompletableFuture ì§ì ‘ ê´€ë¦¬ |
| **Spring Event** | ëŠìŠ¨í•œ ê²°í•©, í™•ì¥ì„± | ì§ì ‘ í˜¸ì¶œ (ê°•í•œ ê²°í•©) |
| **Redis** | ë¹ ë¥¸ ì¡°íšŒ, TTL ì§€ì› | DB (ëŠë¦¼) |
| **@Retryable** | ì„ ì–¸ì  ì¬ì‹œë„, Spring í‘œì¤€ | ìˆ˜ë™ ì¬ì‹œë„ ë¡œì§ |

### ìµœì¢… ì¶”ì²œ êµ¬ì¡°

```
âœ… Semaphore (50) - ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´
âœ… Virtual Thread - 1000ê°œ ì‘ì—… ëª¨ë‘ ë¹„ë™ê¸° ì²˜ë¦¬
âœ… CompletableFuture - ë…¼ë¸”ë¡œí‚¹ ë¹„ë™ê¸°
âœ… Event ê¸°ë°˜ - Passport ì—…ë°ì´íŠ¸ ë¶„ë¦¬
âœ… Redis - ì§„í–‰ ìƒí™© ì¶”ì  (24ì‹œê°„ TTL)
âœ… @Retryable - ìë™ ì¬ì‹œë„ (3íšŒ, 5ì´ˆ ê°„ê²©)
```

---

## êµ¬í˜„ ìƒì„¸

### 1. AsyncConfig (Virtual Thread Executor + Scheduling)

```java
@Slf4j
@Configuration
@EnableAsync
@EnableScheduling  // ìŠ¤ì¼€ì¤„ë§ ì§€ì› í™œì„±í™”
public class AsyncConfig implements AsyncConfigurer {

    /**
     * Virtual Thread ê¸°ë°˜ Executor
     * Java 21ì˜ Virtual Threadë¥¼ í™œìš©í•˜ì—¬ ìˆ˜ì²œ ê°œì˜ ë™ì‹œ ì‘ì—… ì²˜ë¦¬ ê°€ëŠ¥
     * I/O ëŒ€ê¸° ì‹œê°„ì´ ê¸´ ì‘ì—…(AI API í˜¸ì¶œ, S3 ì—…ë¡œë“œ ë“±)ì— ìµœì í™”
     */
    @Bean(name = "virtualThreadExecutor")
    @Override
    public Executor getAsyncExecutor() {
        log.info("[Async Config] Virtual Thread Executor ì´ˆê¸°í™”");
        return Executors.newVirtualThreadPerTaskExecutor();
    }

    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return (ex, method, params) -> {
            log.error("[Async Error] ë¹„ë™ê¸° ì‘ì—… ì‹¤íŒ¨ - method: {}, params: {}",
                method.getName(), params, ex);
        };
    }
}
```

**Context7 Best Practice ì ìš©:**
- âœ… `@EnableAsync` + `AsyncConfigurer` êµ¬í˜„
- âœ… `@EnableScheduling`ìœ¼ë¡œ ìŠ¤ì¼€ì¤„ë§ í™œì„±í™”
- âœ… Virtual Thread Executor ì‚¬ìš© (`Executors.newVirtualThreadPerTaskExecutor()`)
- âœ… `AsyncUncaughtExceptionHandler`ë¡œ ì˜ˆì™¸ ì²˜ë¦¬

---

### 2. BatchProgress Entity (Redis)

```java
@Getter
@Builder
@RedisHash(value = "batch:progress", timeToLive = 86400) // 24ì‹œê°„ TTL
public class BatchProgress implements Serializable {

    @Id
    private String batchId;
    private int total;

    @Builder.Default
    private AtomicInteger completed = new AtomicInteger(0);

    @Builder.Default
    private AtomicInteger failed = new AtomicInteger(0);

    private LocalDateTime startTime;
    private LocalDateTime endTime;

    public void incrementCompleted() {
        this.completed.incrementAndGet();
    }

    public void incrementFailed() {
        this.failed.incrementAndGet();
    }

    public int getRemaining() {
        return total - completed.get() - failed.get();
    }

    public double getProgressPercentage() {
        if (total == 0) return 0.0;
        return (completed.get() + failed.get()) * 100.0 / total;
    }

    public boolean isCompleted() {
        return getRemaining() == 0;
    }
}
```

**Context7 Best Practice ì ìš©:**
- âœ… `@RedisHash` with TTL (24ì‹œê°„)
- âœ… `Serializable` êµ¬í˜„
- âœ… `AtomicInteger`ë¡œ ë™ì‹œì„± ì•ˆì „ ë³´ì¥

---

### 3. BatchImageGenerationService (í•µì‹¬ ë¡œì§)

```java
@Slf4j
@Service
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public class BatchImageGenerationService {

    private final ImageGenerationService imageGenerationService;
    private final PassportQueryService passportQueryService;
    private final BatchProgressRepository progressRepository;
    private final ApplicationEventPublisher eventPublisher;
    private final Executor virtualThreadExecutor;

    /**
     * ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œí•œ (Semaphore)
     * 50ê°œ ë™ì‹œ ì‹¤í–‰ìœ¼ë¡œ ì œí•œí•˜ì—¬ ì‹œìŠ¤í…œ ì•ˆì •ì„± í™•ë³´
     */
    private final Semaphore semaphore = new Semaphore(50);

    /**
     * ëª¨ë“  ì‚¬ìš©ìì˜ Passport ì´ë¯¸ì§€ ë°°ì¹˜ ìƒì„±
     */
    public String generatePassportImagesForAllUsers(final List<Long> userIds) {
        String batchId = UUID.randomUUID().toString();
        int totalUsers = userIds.size();

        log.info("[Batch Image] ë°°ì¹˜ ì‘ì—… ì‹œì‘ - batchId: {}, ì´ ì‚¬ìš©ì ìˆ˜: {}",
            batchId, totalUsers);

        // ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
        BatchProgress progress = BatchProgress.builder()
            .batchId(batchId)
            .total(totalUsers)
            .completed(new AtomicInteger(0))
            .failed(new AtomicInteger(0))
            .startTime(LocalDateTime.now())
            .build();

        progressRepository.save(progress);

        // ëª¨ë“  ì‘ì—…ì„ ë¹„ë™ê¸°ë¡œ ì‹œì‘
        userIds.forEach(userId -> generateImageAsync(batchId, userId, progress));

        return batchId;
    }

    /**
     * ê° ì‚¬ìš©ìì˜ ì´ë¯¸ì§€ë¥¼ ë¹„ë™ê¸°ë¡œ ìƒì„±
     * Semaphoreë¡œ ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´
     */
    private void generateImageAsync(final String batchId, final Long userId,
                                    final BatchProgress progress) {
        CompletableFuture.runAsync(() -> {
            try {
                // Semaphoreë¡œ ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´
                semaphore.acquire();
                log.debug("[Batch Image] ì‘ì—… ì‹œì‘ - userId: {}, í™œì„± ì‘ì—… ìˆ˜: {}",
                    userId, 50 - semaphore.availablePermits());

                try {
                    processUserImage(batchId, userId);
                    progress.incrementCompleted();
                    log.info("[Batch Image] ì‘ì—… ì™„ë£Œ - userId: {}, ì§„í–‰ë¥ : {}/{} ({:.1f}%)",
                        userId, progress.getCompleted().get(), progress.getTotal(),
                        progress.getProgressPercentage());
                } finally {
                    semaphore.release();
                    updateProgressInRedis(progress);
                }

            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                log.error("[Batch Image] ì‘ì—… ì¤‘ë‹¨ - userId: {}", userId, e);
                progress.incrementFailed();
                updateProgressInRedis(progress);
            } catch (Exception e) {
                log.error("[Batch Image] ì‘ì—… ì‹¤íŒ¨ - userId: {}", userId, e);
                progress.incrementFailed();
                updateProgressInRedis(progress);
            }
        }, virtualThreadExecutor);
    }

    /**
     * ì‹¤ì œ ì´ë¯¸ì§€ ìƒì„± ë° ì²˜ë¦¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
     * ìµœëŒ€ 3íšŒ ì¬ì‹œë„, 5ì´ˆ ê°„ê²©
     */
    @Retryable(
        retryFor = {AiException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 5000)
    )
    private void processUserImage(final String batchId, final Long userId) {
        try {
            // 1. Passport ì¡°íšŒ
            Passport passport = passportQueryService.findLatestByUserId(userId)
                .orElseThrow(() -> new AiException(ErrorCode.PASSPORT_NOT_FOUND));

            // 2. í”„ë¡¬í”„íŠ¸ ìƒì„±
            String prompt = buildPromptFromPassport(passport);

            // 3. ì´ë¯¸ì§€ ìƒì„± (2ë¶„ ì†Œìš”)
            log.debug("[Batch Image] ì´ë¯¸ì§€ ìƒì„± ì‹œì‘ - userId: {}, passportId: {}",
                userId, passport.getId());
            String imageUrl = imageGenerationService.generate(prompt);

            // 4. ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ (Passport ì—…ë°ì´íŠ¸ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬)
            eventPublisher.publishEvent(
                new PassportImageGeneratedEvent(this, batchId, userId,
                    passport.getId(), imageUrl)
            );

            log.info("[Batch Image] ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ - userId: {}, imageUrl: {}",
                userId, imageUrl);

        } catch (AiException e) {
            log.error("[Batch Image] AI ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ - userId: {}", userId, e);
            throw e; // ì¬ì‹œë„ë¥¼ ìœ„í•´ ì˜ˆì™¸ ì¬ë°œìƒ
        } catch (Exception e) {
            log.error("[Batch Image] ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ - userId: {}", userId, e);
            throw new AiException(ErrorCode.AI_IMAGE_GENERATION_FAILED);
        }
    }
}
```

**í•µì‹¬ í¬ì¸íŠ¸:**
1. **Semaphore(50)**: ë™ì‹œ ì‹¤í–‰ 50ê°œë¡œ ì œí•œ
2. **Virtual Thread**: `virtualThreadExecutor`ë¡œ ìˆ˜ì²œ ê°œ ì‘ì—… ì²˜ë¦¬
3. **@Retryable**: ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ (3íšŒ, 5ì´ˆ ê°„ê²©)
4. **Event Publishing**: ì™„ë£Œ í›„ ì´ë²¤íŠ¸ ë°œí–‰ìœ¼ë¡œ ëŠìŠ¨í•œ ê²°í•©

---

### 4. Event & Listener

#### PassportImageGeneratedEvent

```java
@Getter
public class PassportImageGeneratedEvent extends ApplicationEvent {

    private final String batchId;
    private final Long userId;
    private final Long passportId;
    private final String imageUrl;

    public PassportImageGeneratedEvent(Object source, String batchId,
                                      Long userId, Long passportId, String imageUrl) {
        super(source);
        this.batchId = batchId;
        this.userId = userId;
        this.passportId = passportId;
        this.imageUrl = imageUrl;
    }
}
```

**Context7 Best Practice:**
- âœ… `ApplicationEvent` ìƒì†
- âœ… ë¶ˆë³€ í•„ë“œ (final)

#### PassportImageEventListener

```java
@Slf4j
@Component
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public class PassportImageEventListener {

    private final PassportCommandService passportCommandService;

    /**
     * ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ ì‹œ Passport ì—…ë°ì´íŠ¸
     * Virtual Threadì—ì„œ ë¹„ë™ê¸° ì‹¤í–‰
     */
    @Async("virtualThreadExecutor")
    @EventListener
    @Transactional
    public void handleImageGenerated(final PassportImageGeneratedEvent event) {
        try {
            log.info("[Event] Passport ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì‹œì‘ - passportId: {}",
                event.getPassportId());

            passportCommandService.updateCoverImage(
                event.getPassportId(),
                event.getImageUrl()
            );

            log.info("[Event] Passport ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ - passportId: {}",
                event.getPassportId());

        } catch (Exception e) {
            log.error("[Event] Passport ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - passportId: {}, batchId: {}",
                event.getPassportId(), event.getBatchId(), e);
        }
    }
}
```

**Context7 Best Practice:**
- âœ… `@EventListener` + `@Async` ì¡°í•©
- âœ… Virtual Threadì—ì„œ ë¹„ë™ê¸° ì‹¤í–‰
- âœ… `@Transactional`ë¡œ íŠ¸ëœì­ì…˜ ê´€ë¦¬

---

### 5. Controller & DTO

#### BatchImageCommandController

```java
@Slf4j
@Tag(name = "Batch AI", description = "ë°°ì¹˜ AI ì´ë¯¸ì§€ ìƒì„± API")
@RestController
@RequestMapping("/api/batch/images")
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public class BatchImageCommandController {

    private final BatchImageGenerationService batchImageGenerationService;
    private final PassportFacadeService passportFacadeService;

    /**
     * íŠ¹ì • ì‚¬ìš©ìë“¤ì˜ Passport ì´ë¯¸ì§€ ë°°ì¹˜ ìƒì„±
     */
    @PostMapping
    @Operation(summary = "ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„±",
               description = "ì§€ì •ëœ ì‚¬ìš©ìë“¤ì˜ Passport ì»¤ë²„ ì´ë¯¸ì§€ë¥¼ ë°°ì¹˜ë¡œ ìƒì„±í•©ë‹ˆë‹¤")
    public ResponseEntity<BaseResponse<BatchImageGenerationResDto>> generateBatchImages(
        @Valid @RequestBody BatchImageGenerationReqDto request
    ) {
        log.info("[Batch API] ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ - ì‚¬ìš©ì ìˆ˜: {}",
            request.userIds().size());

        String batchId = batchImageGenerationService
            .generatePassportImagesForAllUsers(request.userIds());

        BatchImageGenerationResDto response = BatchImageGenerationResDto
            .of(batchId, request.userIds().size());

        return ResponseUtils.ok(response);
    }

    /**
     * íŠ¹ì • ì—°ë„/ì›”ì— ë°©ë¬¸ ê¸°ë¡ì´ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì˜ Passport ì´ë¯¸ì§€ ìƒì„±
     */
    @PostMapping("/month/{year}/{month}")
    @Operation(summary = "ì›”ë³„ ì „ì²´ ì‚¬ìš©ì ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„±",
        description = "íŠ¹ì • ì—°ë„/ì›”ì— ë°©ë¬¸ ê¸°ë¡ì´ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì˜ Passport ì´ë¯¸ì§€ë¥¼ ë°°ì¹˜ë¡œ ìƒì„±")
    public ResponseEntity<BaseResponse<BatchImageGenerationResDto>>
            generateMonthlyBatchImages(
        @PathVariable Integer year,
        @PathVariable Integer month
    ) {
        log.info("[Batch API] ì›”ë³„ ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„± ìš”ì²­ - year: {}, month: {}",
            year, month);

        List<Long> userIds = passportFacadeService.findUsersWithVisitsInMonth(year, month);

        if (userIds.isEmpty()) {
            log.warn("[Batch API] í•´ë‹¹ ì›”ì— ë°©ë¬¸ ê¸°ë¡ì´ ìˆëŠ” ì‚¬ìš©ì ì—†ìŒ");
            return ResponseUtils.ok(BatchImageGenerationResDto.of("NO_USERS", 0));
        }

        String batchId = batchImageGenerationService
            .generatePassportImagesForAllUsers(userIds);

        return ResponseUtils.ok(BatchImageGenerationResDto.of(batchId, userIds.size()));
    }

    /**
     * ë°°ì¹˜ ì§„í–‰ ìƒí™© ì¡°íšŒ
     */
    @GetMapping("/progress/{batchId}")
    @Operation(summary = "ë°°ì¹˜ ì§„í–‰ ìƒí™© ì¡°íšŒ",
               description = "ë°°ì¹˜ ì‘ì—…ì˜ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™©ì„ ì¡°íšŒí•©ë‹ˆë‹¤")
    public ResponseEntity<BaseResponse<BatchProgressResDto>> getProgress(
        @PathVariable String batchId
    ) {
        log.info("[Batch API] ì§„í–‰ ìƒí™© ì¡°íšŒ - batchId: {}", batchId);

        BatchProgress progress = batchImageGenerationService.getProgress(batchId);
        BatchProgressResDto response = BatchProgressResDto.from(progress);

        return ResponseUtils.ok(response);
    }
}
```

#### DTO ì •ì˜

```java
// Request
public record BatchImageGenerationReqDto(
    @NotEmpty(message = "ì‚¬ìš©ì ID ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    List<Long> userIds
) {}

// Response
public record BatchImageGenerationResDto(
    String batchId,
    int totalTasks,
    String message
) {
    public static BatchImageGenerationResDto of(final String batchId, final int totalTasks) {
        return new BatchImageGenerationResDto(
            batchId,
            totalTasks,
            String.format("ë°°ì¹˜ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ %dê°œ ì‘ì—… ì˜ˆì •ì…ë‹ˆë‹¤.", totalTasks)
        );
    }
}

// Progress Response
@Builder
public record BatchProgressResDto(
    String batchId,
    int total,
    int completed,
    int failed,
    int remaining,
    double progressPercentage,
    boolean isCompleted,
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    LocalDateTime startTime,
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    LocalDateTime endTime,
    Long elapsedSeconds,
    String statusMessage
) {
    public static BatchProgressResDto from(final BatchProgress progress) {
        // ë³€í™˜ ë¡œì§...
    }
}
```

---

### 6. PassportImageScheduler (ìë™ ìŠ¤ì¼€ì¤„ë§)

```java
@Slf4j
@Component
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public class PassportImageScheduler {

    private final BatchImageGenerationService batchImageGenerationService;
    private final PassportFacadeService passportFacadeService;

    /**
     * ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œì— ì „ì›” ì‚¬ìš©ì ì´ë¯¸ì§€ ìë™ ìƒì„±
     * Cron: ì´ˆ(0) ë¶„(0) ì‹œ(2) ì¼(1) ì›”(*) ìš”ì¼(*)
     *
     * ì˜ˆì‹œ:
     * - 2025ë…„ 1ì›” 1ì¼ 02:00 â†’ 2024ë…„ 12ì›” ë°©ë¬¸ì ì´ë¯¸ì§€ ìƒì„±
     * - 2025ë…„ 2ì›” 1ì¼ 02:00 â†’ 2025ë…„ 1ì›” ë°©ë¬¸ì ì´ë¯¸ì§€ ìƒì„±
     */
    @Scheduled(cron = "0 0 2 1 * *", zone = "Asia/Seoul")
    public void generateMonthlyPassportImages() {
        LocalDateTime now = LocalDateTime.now();
        YearMonth lastMonth = YearMonth.from(now.minusMonths(1));
        int year = lastMonth.getYear();
        int month = lastMonth.getMonthValue();

        log.info("[Scheduler] ì›”ë³„ Passport ì´ë¯¸ì§€ ìë™ ìƒì„± ì‹œì‘ - year: {}, month: {}",
            year, month);

        try {
            // ì „ì›” ë°©ë¬¸ ê¸°ë¡ì´ ìˆëŠ” ì‚¬ìš©ì ì¡°íšŒ
            List<Long> userIds = passportFacadeService.findUsersWithVisitsInMonth(year, month);

            if (userIds.isEmpty()) {
                log.warn("[Scheduler] ì „ì›” ë°©ë¬¸ ê¸°ë¡ì´ ìˆëŠ” ì‚¬ìš©ì ì—†ìŒ - year: {}, month: {}",
                    year, month);
                return;
            }

            // ë°°ì¹˜ ì´ë¯¸ì§€ ìƒì„±
            String batchId = batchImageGenerationService
                .generatePassportImagesForAllUsers(userIds);

            log.info("[Scheduler] ì›”ë³„ Passport ì´ë¯¸ì§€ ìë™ ìƒì„± ì™„ë£Œ - batchId: {}, " +
                "ì‚¬ìš©ì ìˆ˜: {}, year: {}, month: {}",
                batchId, userIds.size(), year, month);

        } catch (Exception e) {
            log.error("[Scheduler] ì›”ë³„ Passport ì´ë¯¸ì§€ ìë™ ìƒì„± ì‹¤íŒ¨ - year: {}, month: {}",
                year, month, e);
        }
    }
}
```

**Cron í‘œí˜„ì‹ ì„¤ëª…:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆ (0)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¶„ (0)
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ ì‹œ (2)
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€ ì¼ (1)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€ ì›” (*)
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€ ìš”ì¼ (*)
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
0 0 2 1 * *

ì‹¤í–‰ ì‹œê°: ë§¤ì›” 1ì¼ ì˜¤ì „ 2:00 (Asia/Seoul)
```

**ì‹¤í–‰ ì˜ˆì‹œ:**
| ì‹¤í–‰ ì‹œê° | ëŒ€ìƒ ê¸°ê°„ | ì„¤ëª… |
|----------|----------|------|
| 2025-01-01 02:00 | 2024ë…„ 12ì›” | 12ì›”ì— ë°©ë¬¸í•œ ì‚¬ìš©ìì˜ ì´ë¯¸ì§€ ìƒì„± |
| 2025-02-01 02:00 | 2025ë…„ 1ì›” | 1ì›”ì— ë°©ë¬¸í•œ ì‚¬ìš©ìì˜ ì´ë¯¸ì§€ ìƒì„± |
| 2025-03-01 02:00 | 2025ë…„ 2ì›” | 2ì›”ì— ë°©ë¬¸í•œ ì‚¬ìš©ìì˜ ì´ë¯¸ì§€ ìƒì„± |

**ì¶”ê°€ ìŠ¤ì¼€ì¤„ ì˜µì…˜ (ì£¼ì„ ì²˜ë¦¬ë¨):**
```java
// ì¼ë³„ ì‹¤í–‰ (ë§¤ì¼ ì˜¤ì „ 3ì‹œ, ì „ì¼ ì‚¬ìš©ì)
@Scheduled(cron = "0 0 3 * * *", zone = "Asia/Seoul")
public void generateDailyPassportImages() {
    // ì „ì¼ ë°©ë¬¸ì ì´ë¯¸ì§€ ìƒì„±
}

// ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© (5ë¶„ë§ˆë‹¤)
@Scheduled(cron = "0 */5 * * * *", zone = "Asia/Seoul")
public void testScheduler() {
    // í…ŒìŠ¤íŠ¸ ë¡œì§
}
```

**íŠ¹ì§•:**
- âœ… **ìë™ ì‹¤í–‰**: ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œì— ìë™ìœ¼ë¡œ ì‹¤í–‰
- âœ… **ì „ì›” ëŒ€ìƒ**: ìë™ìœ¼ë¡œ ì „ì›” ë°ì´í„° ê³„ì‚° (YearMonth í™œìš©)
- âœ… **ì•ˆì „í•œ ì˜ˆì™¸ ì²˜ë¦¬**: ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¬ ì‹¤í–‰ì— ì˜í–¥ ì—†ìŒ
- âœ… **ìƒì„¸ ë¡œê¹…**: ì‹œì‘/ì™„ë£Œ/ì‹¤íŒ¨ ë¡œê·¸ë¡œ ì¶”ì  ê°€ëŠ¥
- âœ… **ë¹ˆ ë°ì´í„° ì²´í¬**: ëŒ€ìƒ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ì¡°ê¸° ì¢…ë£Œ

**ìˆ˜ë™ ì‹¤í–‰ê³¼ì˜ ê´€ê³„:**
- Controller APIëŠ” ì—¬ì „íˆ ì‚¬ìš© ê°€ëŠ¥ (ìˆ˜ë™ ì‹¤í–‰)
- SchedulerëŠ” ì •ê¸° ìë™ ì‹¤í–‰ì„ ë‹´ë‹¹
- ë‘ ë°©ì‹ ëª¨ë‘ ë™ì¼í•œ `BatchImageGenerationService` ì‚¬ìš©

---

## ì„±ëŠ¥ ë¶„ì„

### ì‹œê°„ ë³µì¡ë„

```
ìˆœì°¨ ì‹¤í–‰: O(n) = 1000 Ã— 2ë¶„ = 2000ë¶„ (33.3ì‹œê°„)

ë³‘ë ¬ ì‹¤í–‰ (Semaphore):
- O(n/k) where k = ë™ì‹œ ì‹¤í–‰ ìˆ˜
- k=50: 1000/50 Ã— 2ë¶„ = 40ë¶„ âœ…
- k=100: 1000/100 Ã— 2ë¶„ = 20ë¶„ (API limit ì£¼ì˜)
```

### ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

```
Platform Thread (50ê°œ):
- ìŠ¤ë ˆë“œë‹¹ ~1MB
- ì´ ë©”ëª¨ë¦¬: 50MB

Virtual Thread (1000ê°œ):
- ìŠ¤ë ˆë“œë‹¹ ~1-2KB
- ì´ ë©”ëª¨ë¦¬: 1-2MB âœ… (50ë°° ì ˆê°)
```

### ë™ì‹œì„± ì œì–´

| Semaphore ê°’ | ì™„ë£Œ ì‹œê°„ | ë©”ëª¨ë¦¬ | API Rate Limit | ì¶”ì²œ |
|-------------|----------|--------|----------------|------|
| 10 | 200ë¶„ | ìµœì†Œ | ì•ˆì „ | âŒ ë„ˆë¬´ ëŠë¦¼ |
| 30 | 67ë¶„ | ë‚®ìŒ | ì•ˆì „ | âš ï¸ ëŠë¦¼ |
| 50 | 40ë¶„ | ë³´í†µ | ì•ˆì „ | âœ… **ì¶”ì²œ** |
| 100 | 20ë¶„ | ë†’ìŒ | ìœ„í—˜ | âš ï¸ API limit ì£¼ì˜ |

### ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

```json
// GET /api/batch/images/progress/{batchId}
{
  "batchId": "uuid-1234",
  "total": 1000,
  "completed": 450,
  "failed": 5,
  "remaining": 545,
  "progressPercentage": 45.5,
  "isCompleted": false,
  "startTime": "2025-12-23 14:00:00",
  "endTime": null,
  "elapsedSeconds": 1200,
  "statusMessage": "ì§„í–‰ ì¤‘ - 455/1000 (45.5%)"
}
```

---

## Best Practice ì ìš©

### Context7 Spring Framework Best Practices

#### 1. @EnableAsync + Virtual Thread Executor
```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {

    @Bean(name = "virtualThreadExecutor")
    @Override
    public Executor getAsyncExecutor() {
        return Executors.newVirtualThreadPerTaskExecutor();
    }
}
```
**ì¶œì²˜:** [Spring Framework Reference 6.2 - Async Configuration](https://docs.spring.io/spring-framework/reference/6.2/integration/scheduling)

#### 2. ApplicationEventPublisher íŒ¨í„´
```java
// Event Publishing
eventPublisher.publishEvent(new PassportImageGeneratedEvent(...));

// Event Listening
@EventListener
@Async("virtualThreadExecutor")
public void handleImageGenerated(PassportImageGeneratedEvent event) {
    // ë¹„ë™ê¸° ì²˜ë¦¬
}
```
**ì¶œì²˜:** [Spring Framework Reference 6.2 - Application Events](https://docs.spring.io/spring-framework/reference/6.2/core/beans/context-introduction)

#### 3. @Retryable with Backoff
```java
@Retryable(
    retryFor = {AiException.class},
    maxAttempts = 3,
    backoff = @Backoff(delay = 5000)
)
private void processUserImage(String batchId, Long userId) {
    // ì‹¤íŒ¨ ì‹œ 5ì´ˆ í›„ ì¬ì‹œë„, ìµœëŒ€ 3íšŒ
}
```

### Context7 Spring Data Redis Best Practices

#### 1. RedisTemplate with GenericJackson2JsonRedisSerializer
```java
@Bean
public RedisTemplate<String, Object> redisTemplate() {
    RedisTemplate<String, Object> template = new RedisTemplate<>();
    template.setConnectionFactory(redisConnectionFactory());

    template.setKeySerializer(new StringRedisSerializer());
    template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
    template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());

    return template;
}
```
**ì¶œì²˜:** [Spring Data Redis - RedisTemplate Configuration](https://github.com/spring-projects/spring-data-redis)

#### 2. @RedisHash with TTL
```java
@RedisHash(value = "batch:progress", timeToLive = 86400) // 24ì‹œê°„
public class BatchProgress implements Serializable {
    @Id
    private String batchId;
    // ...
}
```

#### 3. Repository íŒ¨í„´
```java
public Optional<BatchProgress> findById(final String batchId) {
    String key = KEY_PREFIX + batchId;
    Object value = redisTemplate.opsForValue().get(key);
    return value instanceof BatchProgress
        ? Optional.of((BatchProgress)value)
        : Optional.empty();
}
```

### í”„ë¡œì íŠ¸ ê´€í–‰ ì¤€ìˆ˜

#### 1. ë¡œê¹… íŒ¨í„´
```java
// êµ¬ì¡°í™”ëœ ë¡œê¹…
log.info("[Batch Image] ì‘ì—… ì‹œì‘ - batchId: {}, ì´ ì‚¬ìš©ì ìˆ˜: {}", batchId, total);
log.debug("[Batch Image] ì‘ì—… ì‹œì‘ - userId: {}, í™œì„± ì‘ì—… ìˆ˜: {}", userId, active);
log.error("[Batch Image] ì‘ì—… ì‹¤íŒ¨ - userId: {}", userId, exception);
```

#### 2. ì½”ë“œ ìŠ¤íƒ€ì¼
```java
@Slf4j
@Service
@RequiredArgsConstructor(access = AccessLevel.PROTECTED)
public class BatchImageGenerationService {
    private final ImageGenerationService imageGenerationService;
    // ...
}
```

#### 3. ErrorCode í™œìš©
```java
BATCH_NOT_FOUND(HttpStatus.NOT_FOUND, "BA-001", "ë°°ì¹˜ ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
BATCH_SAVE_FAILED(HttpStatus.INTERNAL_SERVER_ERROR, "BA-003", "ë°°ì¹˜ ì§„í–‰ ìƒí™© ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."),
```

#### 4. MyBatis íŒ¨í„´
```xml
<!-- PassportCommandMapper.xml -->
<update id="updateCoverImage">
    UPDATE passports
    SET cover_image_url = #{imageUrl},
        updated_at      = CURRENT_TIMESTAMP
    WHERE id = #{passportId}
</update>
```

---

## ì¶”ê°€ êµ¬í˜„ ì‚¬í•­

### 1. build.gradle ì˜ì¡´ì„± ì¶”ê°€

```gradle
dependencies {
    // Spring Retry
    implementation 'org.springframework.retry:spring-retry'
    implementation 'org.springframework:spring-aspects'
}
```

### 2. Application.java ì„¤ì •

```java
@SpringBootApplication
@EnableRetry  // ì¶”ê°€
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 3. Gemini API Rate Limit ëŒ€ì‘ (ì„ íƒ)

```java
@Component
public class GeminiRateLimiter {
    // Google APIëŠ” ë³´í†µ ë¶„ë‹¹ ìš”ì²­ ìˆ˜ ì œí•œ
    private final RateLimiter rateLimiter = RateLimiter.create(10.0); // ì´ˆë‹¹ 10ê°œ

    public void acquirePermit() {
        rateLimiter.acquire(); // ë¸”ë¡œí‚¹ ëŒ€ê¸°
    }
}

// BatchImageGenerationServiceì—ì„œ ì‚¬ìš©
private void processUserImage(...) {
    rateLimiter.acquirePermit(); // API í˜¸ì¶œ ì „ rate limit ì²´í¬
    String imageUrl = imageGenerationService.generate(prompt);
}
```

---

## API ì‚¬ìš© ì˜ˆì‹œ

### 1. ë°°ì¹˜ ì‘ì—… ì‹œì‘

```bash
# íŠ¹ì • ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸
POST http://localhost:8080/api/batch/images
Content-Type: application/json

{
  "userIds": [1, 2, 3, 4, 5, ..., 1000]
}

# ì‘ë‹µ
{
  "status": "SUCCESS",
  "data": {
    "batchId": "550e8400-e29b-41d4-a716-446655440000",
    "totalTasks": 1000,
    "message": "ë°°ì¹˜ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ 1000ê°œ ì‘ì—… ì˜ˆì •ì…ë‹ˆë‹¤."
  }
}
```

```bash
# íŠ¹ì • ì—°ë„/ì›” ì „ì²´ ì‚¬ìš©ì
POST http://localhost:8080/api/batch/images/month/2024/12

# ì‘ë‹µ
{
  "status": "SUCCESS",
  "data": {
    "batchId": "550e8400-e29b-41d4-a716-446655440001",
    "totalTasks": 850,
    "message": "ë°°ì¹˜ ì‘ì—…ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ 850ê°œ ì‘ì—… ì˜ˆì •ì…ë‹ˆë‹¤."
  }
}
```

### 2. ì§„í–‰ ìƒí™© ì¡°íšŒ

```bash
GET http://localhost:8080/api/batch/images/progress/550e8400-e29b-41d4-a716-446655440000

# ì‘ë‹µ (ì§„í–‰ ì¤‘)
{
  "status": "SUCCESS",
  "data": {
    "batchId": "550e8400-e29b-41d4-a716-446655440000",
    "total": 1000,
    "completed": 450,
    "failed": 5,
    "remaining": 545,
    "progressPercentage": 45.5,
    "isCompleted": false,
    "startTime": "2025-12-23 14:00:00",
    "endTime": null,
    "elapsedSeconds": 1200,
    "statusMessage": "ì§„í–‰ ì¤‘ - 455/1000 (45.5%)"
  }
}

# ì‘ë‹µ (ì™„ë£Œ)
{
  "status": "SUCCESS",
  "data": {
    "batchId": "550e8400-e29b-41d4-a716-446655440000",
    "total": 1000,
    "completed": 995,
    "failed": 5,
    "remaining": 0,
    "progressPercentage": 100.0,
    "isCompleted": true,
    "startTime": "2025-12-23 14:00:00",
    "endTime": "2025-12-23 14:42:00",
    "elapsedSeconds": 2520,
    "statusMessage": "ë°°ì¹˜ ì‘ì—… ì™„ë£Œ - ì„±ê³µ: 995, ì‹¤íŒ¨: 5"
  }
}
```

---

## íŒŒì¼ êµ¬ì¡°

```
src/main/java/com/backend/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ AsyncConfig.java                    âœ… NEW
â”‚   â”‚   â””â”€â”€ RedisConfig.java
â”‚   â””â”€â”€ error/
â”‚       â”œâ”€â”€ ErrorCode.java                       âœ… UPDATED
â”‚       â””â”€â”€ exception/
â”‚           â””â”€â”€ AiException.java
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â””â”€â”€ command/
â”‚   â”‚   â”‚       â””â”€â”€ BatchImageCommandController.java    âœ… NEW
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BatchImageGenerationReqDto.java     âœ… NEW
â”‚   â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚   â”‚       â”œâ”€â”€ BatchImageGenerationResDto.java     âœ… NEW
â”‚   â”‚   â”‚       â””â”€â”€ BatchProgressResDto.java            âœ… NEW
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â””â”€â”€ BatchProgress.java               âœ… NEW
â”‚   â”‚   â”œâ”€â”€ event/
â”‚   â”‚   â”‚   â””â”€â”€ PassportImageGeneratedEvent.java âœ… NEW
â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â””â”€â”€ BatchProgressRepository.java     âœ… NEW
â”‚   â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â”‚   â””â”€â”€ PassportImageScheduler.java      âœ… NEW
â”‚   â”‚   â””â”€â”€ service/
â”‚   â”‚       â”œâ”€â”€ batch/
â”‚   â”‚       â”‚   â””â”€â”€ BatchImageGenerationService.java    âœ… NEW
â”‚   â”‚       â””â”€â”€ GeminiImageGenerationService.java
â”‚   â””â”€â”€ passport/
â”‚       â”œâ”€â”€ listener/
â”‚       â”‚   â””â”€â”€ PassportImageEventListener.java  âœ… NEW
â”‚       â”œâ”€â”€ mapper/
â”‚       â”‚   â”œâ”€â”€ command/
â”‚       â”‚   â”‚   â””â”€â”€ PassportCommandMapper.java   âœ… UPDATED
â”‚       â”‚   â””â”€â”€ query/
â”‚       â”‚       â””â”€â”€ PassportQueryMapper.java     âœ… UPDATED
â”‚       â””â”€â”€ service/
â”‚           â”œâ”€â”€ command/
â”‚           â”‚   â”œâ”€â”€ PassportCommandService.java  âœ… UPDATED
â”‚           â”‚   â””â”€â”€ implement/
â”‚           â”‚       â””â”€â”€ PassportCommandServiceImpl.java  âœ… UPDATED
â”‚           â””â”€â”€ query/
â”‚               â”œâ”€â”€ PassportQueryService.java    âœ… UPDATED
â”‚               â””â”€â”€ implement/
â”‚                   â””â”€â”€ PassportQueryServiceImpl.java    âœ… UPDATED
â””â”€â”€ resources/
    â””â”€â”€ mapper/
        â””â”€â”€ passport/
            â”œâ”€â”€ PassportCommandMapper.xml        âœ… UPDATED
            â””â”€â”€ PassportQueryMapper.xml          âœ… UPDATED
```

---

## ê²°ë¡ 

### í•µì‹¬ ì„±ê³¼

1. **ì„±ëŠ¥ ê°œì„ **
   - ìˆœì°¨ ì‹¤í–‰: 33.3ì‹œê°„ â†’ ë³‘ë ¬ ì‹¤í–‰: 40ë¶„ (50ë°° í–¥ìƒ)
   - ë©”ëª¨ë¦¬ íš¨ìœ¨: Platform Thread 50MB â†’ Virtual Thread 2MB (25ë°° ì ˆê°)

2. **ì•ˆì •ì„± í™•ë³´**
   - Semaphoreë¡œ ë™ì‹œ ì‹¤í–‰ ìˆ˜ ì œì–´ (ìŠ¤ë ˆë“œí’€ ê³ ê°ˆ ë°©ì§€)
   - @Retryableë¡œ ìë™ ì¬ì‹œë„ (ì‹¤íŒ¨ìœ¨ ê°ì†Œ)
   - Redis ì§„í–‰ ìƒí™© ì¶”ì  (ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§)

3. **í™•ì¥ì„±**
   - Event ê¸°ë°˜ ì•„í‚¤í…ì²˜ (ëŠìŠ¨í•œ ê²°í•©)
   - Virtual Thread (ë¬´ì œí•œ í™•ì¥ ê°€ëŠ¥)
   - ì›”ë³„ ë°°ì¹˜ ìë™í™” ì§€ì›

4. **Best Practice ì¤€ìˆ˜**
   - Context7 ê³µì‹ ë¬¸ì„œ ê¸°ë°˜ êµ¬í˜„
   - í”„ë¡œì íŠ¸ ì½”ë”© ì»¨ë²¤ì…˜ ì¤€ìˆ˜
   - ì²´ê³„ì ì¸ ë¡œê¹… ë° ì—ëŸ¬ ì²˜ë¦¬

### í–¥í›„ ê°œì„  ë°©í–¥

1. **ëª¨ë‹ˆí„°ë§ ê°•í™”**
   - Prometheus + Grafana ì—°ë™
   - ì‹¤íŒ¨ ì‘ì—… ì•Œë¦¼ (Slack, Email)

2. **ì¬ì²˜ë¦¬ ê¸°ëŠ¥**
   - ì‹¤íŒ¨í•œ ì‘ì—…ë§Œ ì¬ì‹¤í–‰
   - ë°°ì¹˜ ì‘ì—… ì·¨ì†Œ API

3. **ì„±ëŠ¥ ìµœì í™”**
   - Gemini API Rate Limiter ì •êµí™”
   - Semaphore ê°’ ë™ì  ì¡°ì •

---

**ë¬¸ì„œ ì‘ì„±ì¼:** 2025-12-23
**ì‘ì„±ì:** AI Assistant
**í”„ë¡œì íŠ¸:** Comeet Backend - Batch Image Generation System
